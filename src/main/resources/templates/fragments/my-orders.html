<div
  class="mainContent col-lg-9 mb-4 tab-content d-none"
  th:fragment="my-orders"
  id="my-orders"
  th:classappend="${param.tab == 'my-orders'} ? 'active-content' : 'd-none'"
>
  <link rel="stylesheet" th:href="@{/css/my-order.css}" />
  <script src="/addToCart.js"></script>
  <h4 class="h4 font-weight-bold mb-4">My Orders</h4>
  <div class="bg-white shadow-sm rounded-lg p-4 mb-4">
    <main class="py-4">
      <!--Not important
      <div class="d-flex justify-content-between border-bottom pb-2 mb-4 d-none">
        <div class="d-flex space-x-4">
          <a
            class="font-weight-bold border-bottom border-primary pb-1"
            href="#"
          >
            Orders
          </a>
          <a href="#"> Kitchens </a>
        </div>
        <input
          class="form-control"
          placeholder="Filter order history"
          type="text"
        />
      </div>-->
      <!--Current Orders-->
      <div th:if="${not #lists.isEmpty(currentOrders)}">
        <h5 class="h5">Current Orders</h5>
        <div class="space-y-4">
          <div
            class="bg-white p-4 rounded shadow-sm mb-4"
            th:each="order : ${currentOrders}"
          >
            <div class="d-flex justify-content-between mb-4">
              <div class="d-flex align-items-start space-x-4 w-75">
                <!-- Kitchen Image -->
                <img
                  th:alt="${order.kitchen.kitchenName}"
                  class="rounded"
                  height="100"
                  th:src="${order.kitchen.kitchenImagePath}"
                  width="150"
                />
                <div class="ml-3 mr-3 order-info-container">
                  <div class="d-flex justify-content-between w-100">
                    <div class="d-flex align-items-center space-x-2">
                      <!-- Kitchen Name -->
                      <h3
                        class="h5 font-weight-bold"
                        th:text="${order.kitchen.kitchenName}"
                      ></h3>
                    </div>
                    <!-- Total Price -->
                    <p
                      class="h5 font-weight-bold ml-4"
                      th:text="'Rs' + ${#numbers.formatDecimal(order.totalAmount, 1, 2)}"
                    ></p>
                  </div>
                  <!-- Order Date -->
                  <p
                    class="text-muted"
                    th:text="${#temporals.format(order.orderDate, 'MMMM dd, yyyy')}"
                  ></p>
                  <!-- Order Status -->
                  <strong
                    ><p class="text-muted" th:text="${order.status}"></p
                  ></strong>
                  <!-- Order Details (more than 2 Items) -->
                  <div th:if="${order.orderDetails.size() > 2}" class="marquee">
                    <div class="marquee-content">
                      <p
                        th:each="item : ${order.orderDetails}"
                        class="border-top"
                      >
                        <span
                          th:text="${item.quantity} + ' ' + ${item.menuItem.name} + ' Rs' + ${#numbers.formatDecimal(item.price, 1, 2)}"
                        ></span>
                      </p>
                    </div>
                  </div>
                  <!-- Order Details (Maximum 2 items)-->
                  <div th:unless="${order.orderDetails.size() > 2}">
                    <p
                      th:each="item : ${order.orderDetails}"
                      class="border-top"
                    >
                      <span
                        th:text="${item.quantity} + ' ' + ${item.menuItem.name} + ' Rs' + ${#numbers.formatDecimal(item.price, 1, 2)}"
                      ></span>
                    </p>
                  </div>
                  <!-- View Receipt Link -->
                  <button
                    class="btn btn-outline-primary btn-sm view-receipt-btn"
                    th:data-order-id="${order.id}"
                    th:data-kitchen-delivery="${order.kitchen.deliveryFees}"
                    th:data-order-date="${#temporals.format(order.orderDate, 'dd-MM-yyyy')}"
                    th:data-order-total="${order.totalAmount}"
                    th:data-order-status="${order.status}"
                    th:data-order-details="${order.orderDetails}"
                    th:data-payment-status="Paid"
                    th:onclick="showReceipt(this)"
                  >
                    View Receipt
                  </button>
                </div>
              </div>
              <!-- Buttons and Rating -->
              <div
                class="text-right d-flex flex-column justify-content-between space-y-2 w-25"
              >
                <div
                  class="d-flex flex-column justify-content-center align-items-center"
                >
                  <!-- Track Order Button (Visible for PENDING or PROCESSING status) -->
                  <button
                    class="btn btn-primary w-100 mb-2"
                    data-toggle="modal"
                    data-target="#trackingModal"
                    th:data-order-id="${order.id}"
                    th:data-expected-delivery-time="${order.kitchen.maxDeliveryTime}"
                    th:data-delivery-address="${order.user.address}"
                    th:data-contact-info="${order.kitchen.phoneNumber}"
                    th:data-status="${order.status}"
                    onclick="loadTrackingModal(this)"
                  >
                    Track your order
                  </button>
                  <!-- Cancel Order Button -->
                  <button
                    class="btn btn-danger w-100 mb-2"
                    th:data-order-id="${order.id}"
                    data-toggle="modal"
                    data-target="#cancelOrderModal"
                    onclick="setOrderIdToCancel(this)"
                  >
                    Cancel Order
                  </button>
                </div>

                <!-- Rating Stars -->
                <div class="text-warning mt-4 d-flex justify-content-center">
                  <!-- Star 1 -->
                  <i
                    th:class="${order.rating >= 1 ? 'fas fa-star text-warning' : 'far fa-star'}"
                  ></i>
                  <!-- Star 2 -->
                  <i
                    th:class="${order.rating >= 2 ? 'fas fa-star text-warning' : 'far fa-star'}"
                  ></i>
                  <!-- Star 3 -->
                  <i
                    th:class="${order.rating >= 3 ? 'fas fa-star text-warning' : 'far fa-star'}"
                  ></i>
                  <!-- Star 4 -->
                  <i
                    th:class="${order.rating >= 4 ? 'fas fa-star text-warning' : 'far fa-star'}"
                  ></i>
                  <!-- Star 5 -->
                  <i
                    th:class="${order.rating >= 5 ? 'fas fa-star text-warning' : 'far fa-star'}"
                  ></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--Past Orders-->
      <div th:if="${not #lists.isEmpty(pastOrders)}">
        <h5 class="h5">Past Orders</h5>
        <div class="space-y-4">
          <div
            class="bg-white p-4 rounded shadow-sm mb-4"
            th:each="order : ${pastOrders}"
          >
            <div class="d-flex justify-content-between mb-4">
              <div class="d-flex align-items-start space-x-4 w-75">
                <!-- Kitchen Image -->
                <img
                  th:alt="${order.kitchen.kitchenName}"
                  class="rounded"
                  height="100"
                  th:src="${order.kitchen.kitchenImagePath}"
                  width="150"
                />
                <div class="ml-3 mr-3 order-info-container">
                  <div class="d-flex justify-content-between w-100">
                    <div class="d-flex align-items-center space-x-2">
                      <!-- Kitchen Name -->
                      <h3
                        class="h5 font-weight-bold"
                        th:text="${order.kitchen.kitchenName}"
                      ></h3>
                    </div>
                    <!-- Total Price -->
                    <p
                      class="h5 font-weight-bold ml-4"
                      th:text="'Rs' + ${#numbers.formatDecimal(order.totalAmount, 1, 2)}"
                    ></p>
                  </div>
                  <!-- Order Date -->
                  <p
                    class="text-muted"
                    th:text="${#temporals.format(order.orderDate, 'MMMM dd, yyyy')}"
                  ></p>
                  <!-- Order Status -->
                  <strong
                    ><p class="text-muted" th:text="${order.status}"></p
                  ></strong>
                  <!-- Order Details (more than 2 Items) -->
                  <div th:if="${order.orderDetails.size() > 2}" class="marquee">
                    <div class="marquee-content">
                      <p
                        th:each="item : ${order.orderDetails}"
                        class="border-top"
                      >
                        <span
                          th:text="${item.quantity} + ' ' + ${item.menuItem.name} + ' Rs' + ${#numbers.formatDecimal(item.price, 1, 2)}"
                        ></span>
                      </p>
                    </div>
                  </div>
                  <!-- Order Details (Maximum 2 items)-->
                  <div th:unless="${order.orderDetails.size() > 2}">
                    <p
                      th:each="item : ${order.orderDetails}"
                      class="border-top"
                    >
                      <span
                        th:text="${item.quantity} + ' ' + ${item.menuItem.name} + ' Rs' + ${#numbers.formatDecimal(item.price, 1, 2)}"
                      ></span>
                    </p>
                  </div>
                  <!-- View Receipt Link -->
                  <button
                    class="btn btn-outline-primary btn-sm view-receipt-btn"
                    th:data-order-id="${order.id}"
                    th:data-kitchen-delivery="${order.kitchen.deliveryFees}"
                    th:data-order-date="${#temporals.format(order.orderDate, 'dd-MM-yyyy')}"
                    th:data-order-total="${order.totalAmount}"
                    th:data-order-status="${order.status}"
                    th:data-order-details="${order.orderDetails}"
                    th:data-payment-status="Paid"
                    th:onclick="showReceipt(this)"
                    
                  >
                    View Receipt
                  </button>
                </div>
              </div>
              <!-- Buttons and Rating -->
              <div
                class="text-right d-flex flex-column justify-content-between space-y-2 w-25"
              >
                <!-- Express Reorder and Add to Bag Buttons (Visible for other statuses) -->
                <div>
                  <button th:data-order-id="${order.id}" onclick="buildCart(this.getAttribute('data-order-id'))" class="btn btn-primary w-100 mb-2">
                    Express reorder
                  </button>
                  <button 
                      id="rate-order"
                      class="btn btn-outline-primary w-100 mb-2" 
                      data-bs-toggle="modal" 
                      th:attr="data-kitchen-name=${order.kitchen.kitchenName}"
                      data-bs-target="#ratingModal" 
                      th:data-order-id="${order.id}">
                    Rate this order
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Rating Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1" aria-labelledby="ratingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning text-white">
            <h5 class="modal-title" id="ratingModalLabel">Rate Your Experience</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Kitchen Name -->
            <div class="mb-4">
              <h4 class="h5 text-dark">Kitchen: <span id="kitchenName" class="text-warning"></span></h4>
            </div>

            <!-- Kitchen Rating -->
            <div class="mb-4">
              <label class="form-label text-dark">Rate the Kitchen:</label>
              <div class="star-rating">
                <span class="star" data-value="1">&#9733;</span>
                <span class="star" data-value="2">&#9733;</span>
                <span class="star" data-value="3">&#9733;</span>
                <span class="star" data-value="4">&#9733;</span>
                <span class="star" data-value="5">&#9733;</span>
              </div>
              <input type="hidden" id="kitchenRating" name="kitchenRating" value="0">
            </div>

            <!-- User Note -->
            <div class="mb-4">
              <label for="userNote" class="form-label text-dark">Leave a note (optional):</label>
              <textarea class="form-control" id="userNote" rows="3"></textarea>
            </div>

            <!-- Order Details -->
            <div class="mb-4">
              <h5 class="h6 text-dark">Rate Your Ordered Items:</h5>
              <div id="orderItemsRating">
                <!-- Dynamically generated order items with star ratings -->
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-warning" onclick="submitRatings()">Submit Ratings</button>
          </div>
        </div>
      </div>
    </div>


      <!--No Orders-->
      <div
        th:if="${#lists.isEmpty(pastOrders) and #lists.isEmpty(currentOrders)}"
      >
        <div class="text-center p-5 bg-light rounded shadow-sm">
          <!-- Font Awesome Icon -->
          <div class="mb-4">
            <i class="fas fa-shopping-basket fa-4x text-warning"></i>
          </div>
          <!-- Message -->
          <h3 class="h4 text-muted mb-3">You have no orders yet.</h3>
          <p class="text-muted mb-4">
            Start exploring our kitchens and place your first order!
          </p>
          <!-- Orange-themed button to go back to the kitchens page -->
          <a th:href="@{/kitchens}" class="btn btn-warning btn-lg">
            <i class="fas fa-utensils"></i> Explore Kitchens
          </a>
        </div>
      </div>

      <!-- The Track Modal -->
      <div
        class="modal fade"
        id="trackingModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="trackingModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="trackingModalLabel">
                Order Tracking
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="container info-box">
                <h4 class="mb-3">Food Order Information</h4>
                <div class="mb-3">
                  <p>
                    <strong>Order ID:</strong>
                    <span id="tracking-orderId">987654321</span>
                  </p>
                  <p>
                    <strong>Expected Delivery Time:</strong>
                    <span id="tracking-expectedDeliveryTime">30-45 Minutes</span>
                  </p>
                  <p>
                    <strong>Delivery Address:</strong>
                    <span id="tracking-deliveryAddress"
                      >456 Foodie Lane, Gourmet City, USA</span
                    >
                  </p>
                  <p>
                    <strong>Contact Info:</strong>
                    <span id="tracking-contactInfo">+1 234 567 890</span>
                  </p>
                </div>
                <div
                  class="d-flex align-items-center justify-content-center mt-4"
                >
                  <!-- Pending -->
                  <div class="d-flex flex-column align-items-center">
                    <div class="status-circle bg-warning">
                      <i class="fas fa-hourglass-start"></i>
                    </div>
                    <span class="status-text text-warning">Pending</span>
                  </div>
                  <div class="status-line"></div>
                  <!-- Preparing -->
                  <div class="d-flex flex-column align-items-center">
                    <div class="status-circle bg-warning">
                      <i class="fas fa-utensils"></i>
                    </div>
                    <span class="status-text text-warning">Preparing</span>
                  </div>
                  <div class="status-line"></div>
                  <!-- On The Way -->
                  <div class="d-flex flex-column align-items-center">
                    <div class="status-circle bg-warning">
                      <i class="fas fa-motorcycle"></i>
                    </div>
                    <span class="status-text text-warning">On The Way</span>
                  </div>
                  <div class="status-line status-line-gray"></div>
                  <!-- Delivered -->
                  <div class="d-flex flex-column align-items-center">
                    <div class="status-circle bg-secondary">
                      <i class="fas fa-home"></i>
                    </div>
                    <span class="status-text text-secondary">Delivered</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Cancel Order Confirmation Modal -->
      <div
        class="modal fade"
        id="cancelOrderModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="cancelOrderModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cancelOrderModalLabel">
                Cancel Order
              </h5>
              <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
              >
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Are you sure you want to cancel this order?
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-dismiss="modal"
              >
                No, Keep Order
              </button>
              <button
                type="button"
                class="btn btn-danger"
                th:onclick="cancelOrder()"
              >
                Yes, Cancel Order
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal for Order Details -->
      <div
        class="modal fade"
        id="receiptDetailsModal"
        tabindex="-1"
        aria-labelledby="receiptDetailsModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="receiptDetailsModalLabel">
                Receipt
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <!-- Order Summary -->
              <div>
                <h6 class="mb-3 sub-title">Order Summary</h6>
                <div class="row">
                  <div class="col-md-6">
                    <p>
                      <strong>Order ID:</strong>
                      <span id="receipt-orderId"></span>
                    </p>
                    <p>
                      <strong>Order Date:</strong>
                      <span id="receipt-orderDate"></span>
                    </p>
                  </div>
                  <div class="col-md-6">
                    <p>
                      <strong>Total Amount:</strong>
                      <span id="receipt-orderTotal"></span>
                    </p>
                    <p>
                      <strong>Status:</strong>
                      <span id="receipt-orderStatus"></span>
                    </p>
                    <p>
                      <strong>Payment Status:</strong>
                      <span id="receipt-paymentStatus"></span>
                    </p>
                  </div>
                </div>
              </div>

              <!-- Order Items Table -->
              <div class="mb-4">
                <h6 class="mb-3 sub-title">Order Items</h6>
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Item Name</th>
                      <th>Quantity</th>
                      <th>Price (Rs)</th>
                      <th>Total (Rs)</th>
                    </tr>
                  </thead>
                  <tbody id="receipt-orderItemsTableBody">
                    <!-- Order items will be dynamically added here -->
                  </tbody>
                </table>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Confirmation Modal -->
      <div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cartModalLabel">Confirm Action</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Your cart is not empty. Do you want to clear it and add new items?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" id="confirmAdd" class="btn btn-primary">Confirm</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Function to submit ratings
    function submitRatings() {
      const orderId = document.querySelector('[data-order-id]').getAttribute('data-order-id');
      const kitchenRating = document.getElementById('kitchenRating').value;
      const userNote = document.getElementById('userNote').value;
      const itemRatings = [];

      // Collect ratings for each item
      document.querySelectorAll('.order-item').forEach(item => {
        const itemName = item.querySelector('.item-name').innerText;
        const itemRating = item.querySelector('.item-rating').value;

        itemRatings.push({
          itemName: itemName,
          rating: itemRating
        });
      });

      // Prepare data to send to the server
      const data = {
        kitchenRating: kitchenRating,
        userNote: userNote,
        itemRatings: itemRatings
      };

      // Send data to the server
      fetch(`/orders/${orderId}/ratings`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert('Thank you for your feedback!');
          // Close the modal
          const ratingModal = bootstrap.Modal.getInstance(document.getElementById('ratingModal'));
          ratingModal.hide();
        } else {
          alert('Failed to submit ratings. Please try again.');
        }
      })
      .catch(error => console.error('Error:', error));
    }
        // Function to fetch and populate ratings
        function fetchAndPopulateRatings(orderId) {

          let data = document.getElementById('rate-order');
          let kitchenName = data.getAttribute('data-kitchen-name');
          let kitchenElement = document.getElementById('kitchenName');
          if(kitchenElement){
            kitchenElement.textContent = `${kitchenName}`;
          }
          fetch(`/orders/${orderId}/ratings`)
            .then(response => response.json())
            .then(data => {
              if (data) {
                // Populate kitchen rating
                if (data.kitchenRating > 0) {
                  document.getElementById('kitchenRating').value = data.kitchenRating;
                  highlightStars('kitchenRating', data.kitchenRating);
                }

                // Populate user note
                if (data.userNote) {
                  document.getElementById('userNote').value = data.userNote;
                }

                // Populate item ratings
                // Assuming 'data' is an object containing the itemRatings array
                if (data.itemRatings && data.itemRatings.length > 0) {
                  const container = document.getElementById('orderItemsRating'); // Assuming you have a container to hold all the items

                  data.itemRatings.forEach(item => {
                    // Create the HTML structure for each item
                    const itemHTML = `
                      <div class="order-item mb-3">
                        <p class="mb-1 text-dark">Item: <span class="item-name text-warning">${item.itemName}</span></p>
                        <div class="star-rating">
                          <span class="star" data-value="1">&#9733;</span>
                          <span class="star" data-value="2">&#9733;</span>
                          <span class="star" data-value="3">&#9733;</span>
                          <span class="star" data-value="4">&#9733;</span>
                          <span class="star" data-value="5">&#9733;</span>
                        </div>
                        <input type="hidden" class="item-rating" name="itemRating" value="${item.rating}">
                      </div>
                    `;

                    // Append the HTML to the container
                    container.insertAdjacentHTML('beforeend', itemHTML);

                    // Highlight the stars based on the rating
                    const ratingInput = container.lastElementChild.querySelector('.item-rating');
                    highlightStars(ratingInput, item.rating);
                  });
                }
              }
            })
            .catch(error => console.error('Error fetching ratings:', error));
        }

        // Function to highlight stars based on rating
        function highlightStars(ratingInput, rating) {
          const stars = ratingInput.closest('.order-item').querySelectorAll('.star');
          stars.forEach((star, index) => {
            if (index < rating) {
              star.classList.add('active');
            } else {
              star.classList.remove('active');
            }
          });
        }

        // Function to handle modal opening
        document.getElementById('ratingModal').addEventListener('show.bs.modal', function (event) {
          const button = event.relatedTarget; // Button that triggered the modal
          const orderId = button.getAttribute('data-order-id'); // Extract order ID from data-order-id attribute
          fetchAndPopulateRatings(orderId); // Fetch and populate ratings
        });

        let orderIdToCancel = null;

        // Set the orderId to cancel when the button is clicked
        function setOrderIdToCancel(button) {
          orderIdToCancel = button.getAttribute('data-order-id');
        }

        // Handle the actual cancellation
        function cancelOrder() {
          if (!orderIdToCancel) {
            alert('No order selected for cancellation.');
            return;
          }

          // Call the existing endpoint with the CANCELLED status
          fetch(`/orders/${orderIdToCancel}/cancel`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
          })
          .then(data => {
            window.location.href = "/dashboard?tab=my-orders";
          })
            .catch(error => {
              console.error('Error:', error);
              alert('An error occurred while cancelling the order.');
            })
            .finally(() => {

              orderIdToCancel = null;
            });
        }
        function loadTrackingModal(button) {
          // Get data from the button's data-* attributes
          const orderId = button.getAttribute('data-order-id');
          const expectedDeliveryTime = button.getAttribute('data-expected-delivery-time');
          const deliveryAddress = button.getAttribute('data-delivery-address');
          const contactInfo = button.getAttribute('data-contact-info');
          const status = button.getAttribute('data-status');

          // Update modal content with the data
          document.getElementById('tracking-orderId').innerText = orderId;
          document.getElementById('tracking-expectedDeliveryTime').innerText = expectedDeliveryTime;
          document.getElementById('tracking-deliveryAddress').innerText = deliveryAddress;
          document.getElementById('tracking-contactInfo').innerText = contactInfo;

          // Update order status
          updateOrderStatus(status);
        }
        function updateOrderStatus(status) {
          // Reset all status circles and lines
          const statusCircles = document.querySelectorAll('.status-circle');
          const statusLines = document.querySelectorAll('.status-line');
          const statusTexts = document.querySelectorAll('.status-text');

          statusCircles.forEach(circle => {
            circle.classList.remove('bg-success', 'bg-warning', 'bg-secondary');
            circle.classList.add('bg-secondary'); // Default color for incomplete steps
          });

          statusLines.forEach(line => {
            line.classList.remove('bg-success', 'bg-warning');
            line.classList.add('status-line-gray'); // Default color for incomplete steps
          });

          statusTexts.forEach(text => {
            text.classList.remove('text-success', 'text-warning');
            text.classList.add('text-secondary'); // Default color for incomplete steps
          });

          // Highlight completed and current steps
          if (status === 'PENDING') {
            // Current step: Pending (orange)
            statusCircles[0].classList.remove('bg-secondary');
            statusCircles[0].classList.add('bg-warning');
            statusTexts[0].classList.remove('text-secondary');
            statusTexts[0].classList.add('text-warning');
          } else if (status === 'PREPARING') {
            // Completed step: Pending (green)
            statusCircles[0].classList.remove('bg-secondary');
            statusCircles[0].classList.add('bg-success');
            statusLines[0].classList.remove('status-line-gray');
            statusLines[0].classList.add('bg-success');
            statusTexts[0].classList.remove('text-secondary');
            statusTexts[0].classList.add('text-success');

            // Current step: Preparing (orange)
            statusCircles[1].classList.remove('bg-secondary');
            statusCircles[1].classList.add('bg-warning');
            statusTexts[1].classList.remove('text-secondary');
            statusTexts[1].classList.add('text-warning');
          } else if (status === 'READY') {
            // Completed steps: Pending and Preparing (green)
            statusCircles[0].classList.remove('bg-secondary');
            statusCircles[0].classList.add('bg-success');
            statusLines[0].classList.remove('status-line-gray');
            statusLines[0].classList.add('bg-success');
            statusTexts[0].classList.remove('text-secondary');
            statusTexts[0].classList.add('text-success');

            statusCircles[1].classList.remove('bg-secondary');
            statusCircles[1].classList.add('bg-success');
            statusLines[1].classList.remove('status-line-gray');
            statusLines[1].classList.add('bg-success');
            statusTexts[1].classList.remove('text-secondary');
            statusTexts[1].classList.add('text-success');

            // Current step: On The Way (orange)
            statusCircles[2].classList.remove('bg-secondary');
            statusCircles[2].classList.add('bg-warning');
            statusTexts[2].classList.remove('text-secondary');
            statusTexts[2].classList.add('text-warning');
          } else if (status === 'DELIVERED') {
            // Completed steps: Pending, Preparing, and On The Way (green)
            statusCircles[0].classList.remove('bg-secondary');
            statusCircles[0].classList.add('bg-success');
            statusLines[0].classList.remove('status-line-gray');
            statusLines[0].classList.add('bg-success');
            statusTexts[0].classList.remove('text-secondary');
            statusTexts[0].classList.add('text-success');

            statusCircles[1].classList.remove('bg-secondary');
            statusCircles[1].classList.add('bg-success');
            statusLines[1].classList.remove('status-line-gray');
            statusLines[1].classList.add('bg-success');
            statusTexts[1].classList.remove('text-secondary');
            statusTexts[1].classList.add('text-success');

            statusCircles[2].classList.remove('bg-secondary');
            statusCircles[2].classList.add('bg-success');
            statusLines[2].classList.remove('status-line-gray');
            statusLines[2].classList.add('bg-success');
            statusTexts[2].classList.remove('text-secondary');
            statusTexts[2].classList.add('text-success');

            // Current step: Delivered (orange)
            statusCircles[3].classList.remove('bg-secondary');
            statusCircles[3].classList.add('bg-warning');
            statusTexts[3].classList.remove('text-secondary');
            statusTexts[3].classList.add('text-warning');
          }
        }
        function showReceipt(button){
          
          // Extract data from the button's data attributes
          const orderId = button.getAttribute('data-order-id');
          const orderDate = button.getAttribute('data-order-date');
          const orderTotal = parseFloat(button.getAttribute('data-order-total'));
          const orderStatus = button.getAttribute('data-order-status');
          const paymentStatus = button.getAttribute('data-payment-status');
          const kitchenDeliveryFees = parseFloat(button.getAttribute('data-kitchen-delivery'));

          // Populate the modal with the extracted data
          document.getElementById('receipt-orderId').textContent = orderId;
          document.getElementById('receipt-orderDate').textContent = orderDate;
          document.getElementById('receipt-orderTotal').textContent = 'Rs ' + orderTotal;
          document.getElementById('receipt-orderStatus').textContent = orderStatus;
          document.getElementById('receipt-paymentStatus').textContent = paymentStatus;

          // Clear the order items table
          const orderItemsTableBody = document.getElementById('receipt-orderItemsTableBody');
          orderItemsTableBody.innerHTML = '';

          // Fetch order items (assuming you have an endpoint to get order items)
          fetch(`/orders/${orderId}/items`)
              .then(response => response.json())
              .then(orderItems => {
                  let subtotal = 0; // Initialize subtotal

                  // Populate the order items table
                  orderItems.forEach(item => {
                      const row = document.createElement('tr');
                      const itemTotal = item.price * item.quantity; // Calculate total for each item
                      subtotal += itemTotal; // Add to subtotal
                      row.innerHTML = `
                          <td>${item.menuItem.name}</td>
                          <td>${item.quantity}</td>
                          <td>Rs ${item.price}</td>
                          <td>Rs ${itemTotal}</td>
                      `;
                      orderItemsTableBody.appendChild(row);
                  });
                  // Add rows for tax, delivery fee, and platform fee
                  const taxRow = document.createElement('tr');
                  taxRow.innerHTML = `
                      <td colspan="3" style="text-align: right;"><strong>Tax (5%):</strong></td>
                      <td><strong>Rs ${(subtotal * 0.05).toFixed(2)}</strong></td>
                  `;
                  orderItemsTableBody.appendChild(taxRow);

                  const deliveryFeeRow = document.createElement('tr');
                  deliveryFeeRow.innerHTML = `
                      <td colspan="3" style="text-align: right;"><strong>Delivery Fee:</strong></td>
                      <td><strong>Rs ${kitchenDeliveryFees.toFixed(2)}</strong></td>
                  `;
                  orderItemsTableBody.appendChild(deliveryFeeRow);

                  const platformFeeRow = document.createElement('tr');
                  platformFeeRow.innerHTML = `
                      <td colspan="3" style="text-align: right;"><strong>Platform Fee:</strong></td>
                      <td><strong>Rs 5.00</strong></td>
                  `;
                  orderItemsTableBody.appendChild(platformFeeRow);

                  // Add a row for the subtotal
                  const subtotalRow = document.createElement('tr');
                  subtotalRow.innerHTML = `
                      <td colspan="3" style="text-align: right;"><strong>Subtotal:</strong></td>
                      <td><strong>Rs ${orderTotal.toFixed(2)}</strong></td>
                  `;
                  orderItemsTableBody.appendChild(subtotalRow);

              })
              .catch(error => {
                  console.error('Error fetching order items:', error);
              });

          // Show the modal
          const modal = new bootstrap.Modal(document.getElementById('receiptDetailsModal'));
          modal.show();
        }
  </script>
</div>
